---
title: "ネットワーキング"
date: 2021-01-30T15:26:01+09:00
draft: false
hide:
- toc
- nextpage
subpage: false
weight: 7
---

1. コンセプト
2. VPC
3. 負荷分散

<!--more-->

- [Google Cloud ネットワーキング プロダクト](https://cloud.google.com/products/networking)
- 接続
    - [Virtual Private Cloud（VPC）](https://cloud.google.com/vpc/docs)

## 1. コンセプト

- VPC ネットワーク
    - グローバルリソース、特定のリージョンやゾーンに関連付けできない
    - リージョンを跨げる、IP レンジは指定しない
    - VPC 内であれば、異なるリージョンのサブネット同士でプライベート IP で通信可能
    - 異なる VPC に所属するサブネット同士はプライベート IP で通信できないため、インターネット経由/Cloud VPN/VPCピアリングなどを利用する
- サブネット
    - リージョンリソース、サブネット毎に IP アドレスの範囲が定義される
    - ゾーンを跨げる
- ファイアウォールルール
    - VM インスタンスで発生するトラフィックをルールベースで許可・拒否
    - 上り（インスタンスに向かっていくトラフィック）・下り（インスタンスから出ていくトラフィック）それぞれで設定する
    - タグやサービスアカウントを適用条件に加えることもできる
    - 以下の暗黙のルールがデフォルトで適用されている（ Cloud Console に表示されない）
        - 暗黙の下り許可ルール：すべてのトラフィックを許可（アクション： `allow` 、宛先： `0.0.0.0/0` ）
        - 暗黙の上り許可ルール：すべてのトラフィックを許可（アクション： `deny` 、送信元： `0.0.0.0/0` ）

## 2. VPC

Virtual Private Cloud（VPC）は、Compute Engine 仮想マシン（VM）インスタンス、Google Kubernetes Engine（GKE）クラスタ、[App Engine フレキシブル環境](https://cloud.google.com/appengine/docs/flexible) にネットワーキング機能を提供する。

### 2.1. VPC ネットワーク

- VPC ネットワークは、データセンター内のリージョン仮想サブネットワーク（ **サブネット** ）のリストで構成されるグローバルリソースであり、すべてグローバルな広域ネットワークで接続される。
- **ルート**、**ファイアウォール** ルールを含む VPC ネットワークは **グローバルリソース** 。特定のリージョンやゾーンには関連付けられていない。
- サブネットは [リージョンリソース](https://cloud.google.com/compute/docs/regions-zones/global-regional-zonal-resources#regionalresources) 。サブネットごとに IP アドレスの範囲が定義される。（ VPC には範囲が定義されない）

### 2.2. VPC のオプション

VPC のオプション、相互接続には以下のサービスがある。

|サービス|内容|
|:---|:---|
|共有 VPC |組織内の複数プロジェクトから共通の VPC として利用できる|
|VPC ピアリング|異なる VPC 間でピアリングを形成し、組織・プロジェクトが異なる VPC であっても互いのサブネット同士がプライベート IP で通信できる|
| Cloud VPN | IPSec 接続を使用して VPC 同士、またはオンプレミスと VPC を接続する |
| Cloud Interconnect |オンプレミスと VPC を専用線接続し、低レイテンシかつ高可用の接続を実現|

### 2.3. サブネット作成モード

サブネット作成モードには、自動モードとカスタムモードの 2 種類ある。

- 自動モード
    - すべてのリージョンに 1 つずつサブネットが自動的に作成
    - 事前定義された IP 範囲（ `10.128.0.0/9` ）が使用される
    - GCP に新しくリージョンが追加されると、サブネットも自動的に追加される
    - カスタムモードへ変更可能
- カスタムモード
    - すべてユーザが作成する必要がある
    - サブネットの IP 範囲は作成後に変更可能であるが、VPC 内の他のサブネットと範囲が重複しないようにする必要があり、且つ、縮小は不可能

## 3. 負荷分散

Cloud Load Balancing　の負荷分散の種類には以下がある。

|種類|内部/外部|リージョン/グローバル|プロキシ/パススルー|
|内部 TCP/UDP |内部|リージョン限定|パススルー|
|内部 HTTP(S) |内部|リージョン限定|プロキシ|
| TCP/UDP ネットワーク|外部|リージョン限定|パススルー|
| TCP プロキシ|外部|グローバル|プロキシ|
| SSL プロキシ|外部|グローバル|プロキシ|
| 外部 HTTP(S) |外部|グローバル|プロキシ|

- 内部/外部
    - 外部：インターネットからのトラフィック
    - 内部： VPC 内のトラフィック
- リージョン/グローバル
    - グローバル
        - バックエンドが複数リージョンに分散
        - 単一のエニーキャスト IP アドレスを使用してアクセスを提供（ IPv6 もある）
        - 「外部」かつ「プロキシ」の負荷分散
    - リージョン
        - バックエンドが同一リージョン内
        - IPv4 のみ
        - 「内部」または「パススルー」の負荷分散
- プロキシ/パススルー
    - プロキシ（ NAT 型）
        - LB で一度接続終端する（送信元 IP が LB の内部 IP に変わる）ため、ファイアウォールルールは VPC ネットワーク内を許可する必要がある
    - パススルー（ DSR 型）
        - 接続終端しないのでクライアントの IP がそのまま届くため、ファイアウォールルールは `0.0.0.0/0` からのトラフィックを許可する必要がある